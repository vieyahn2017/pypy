<!DOCTYPE html>
<html>
   <head>
   	  <meta charset="utf-8"/>
      <title>file upload</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <!-- 引入 Bootstrap -->
      <link href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
      <!--   <link href="style.css" rel="stylesheet">   -->

      <!-- HTML5 Shim 和 Respond.js 用于让 IE8 支持 HTML5元素和媒体查询 -->
      <!-- 注意： 如果通过 file://  引入 Respond.js 文件，则该文件无法起效果 -->
      <!--[if lt IE 9]>
         <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
         <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
      <![endif]-->
      <style type="text/css">
         #speed{
            padding: 5px;
            margin-top: 5px;
            overflow: hidden;
            background: #f4f4f4;
         }
         .bar{
            height: 13px;
            margin-top: 4px;
            width: 15%;
         }
      </style>

   </head>
   <body>
      <div style="text-align: center; padding: 40px 0px;"  height=600>
      </div>

   	<div class="container" >
	   	<div style="text-align: center; padding: 40px 0px;">
	   	</div>


	<form class="form-horizontal"  id="fileform" role="form" action="/file/upload" enctype="multipart/form-data" method="POST">  <!--  -->
        {% raw xsrf_form_html() %}
		    <div class="form-group"> 
		        <!-- {-% raw form.filename.label(class_="col-sm-2 control-label")    %-}  -->
		        <div class="col-sm-10"> 
		            {%raw form.filename(class_="form-control", onChange="_file_show()")  %} 
		        </div> 
		    </div> 
		    <div class="form-group" style="text-align: center;"> 

                 <div class="col-sm-10 col-sm-offset-2">      
                  <div id='speed' class="hidden">
                        <div class="pull-left">
                           <span class="file">xxxxx.text (40.01m)</span>&nbsp; &nbsp; 
                        </div>
                        <div class="progress pull-left bar">
                         <!-- <div id="progressCounter" class="progress-bar progress-bar-info" style="width: 50%;">
                          </div> -->
                          <progress id="progressCounter" value="0" max="100"> </progress>
                        </div>
                        <div class="pull-left">
                           &nbsp; <span>20</span>M/s <span>00:00:20</span> &nbsp;
                        </div>
                        <div class="pull-left" >         
                           <span id="endContent"></span> <a id="delete_upload" href="#" >删除</a>
                        </div>
                  </div> 

                  

                 </div>  <!-- class="col-sm-10 col-sm-offset-2"  -->


              <a href="#" class="btn btn-success" id="ajax_upload" >上传 AJAX</a> 
              <a href="#" class="btn btn-success" id="post_submit">上传 POST（a） </a>
              <input class="btn btn-success" type="submit"  value="上传 POST"></input>
          
          </div>  <!-- class="form-group"  -->
               		     


      </form>

   	</div>




         <script src="https://code.jquery.com/jquery.js"></script>

            <script type="text/javascript" >

            $.ajaxSetup({
                  beforeSend: function(jqXHR, settings) {
                      type = settings.type
                      if (type != 'GET' && type != 'HEAD' && type != 'OPTIONS') {
                          var pattern = /(.+; *)?_xsrf *= *([^;" ]+)/;
                          var xsrf = pattern.exec(document.cookie);
                          /*
                          xsrf
["__guid=96992031.780696353206751600.1472717221660.608;username="2|1:0|10:1473326136|8:username|8:YWRtaW4=|d7dce1bfb1f831347d080d3bd06163e466ac43d02b00c2ec44347ddb83a192c7";_xsrf=2|6c844e1c|f9f1317b6220fb7dff9542b5c254482e|1473390277",
"__guid=96992031.780696353206751600.1472717221660.608;username="2|1:0|10:1473326136|8:username|8:YWRtaW4=|d7dce1bfb1f831347d080d3bd06163e466ac43d02b00c2ec44347ddb83a192c7"; ",
"2|6c844e1c|f9f1317b6220fb7dff9542b5c254482e|1473390277"]
                          * */
                          var _xsrf = xsrf[2];
                          //var _xsrf = $("input[name='_xsrf']").val();
                          if (xsrf) {
                              jqXHR.setRequestHeader("X-CSRFToken", _xsrf);  //现在对了吧？
                          }
                      }
                    }
                  });

                 function _file_show() {  
                    var f = document.getElementById('{%raw form.filename.name%}').files;  
                    $("#speed").removeClass('hidden');
                    
                    _size_num = f[0].size/1024;
                    num = Math.ceil(_size_num);
                    measure ='kb';
                    if(num<100){ num = _size_num.toFixed(1);}
                    else if(num>1024*1024){ measure ='G';num = (_size_num/1024/1024).toFixed(2);}                      
                    else if(num>1024){ measure ='M';num = (_size_num/1024).toFixed(1);}

                    $("#speed span.file").text(f[0].name + '(' +  num + measure+ ')');
                     $("#endContent").html('');
                     var progressElem = $('#progressCounter');
                     progressElem.attr('value', 0);

                }  
            

              $("#post_submit").click(function() {

                    document.getElementById('fileform').submit();
                    var _xsrf = $("input[name='_xsrf']").val();
                    jqXHR.setRequestHeader("X-CSRFToken", _xsrf);

                  //之前的post可以运行，
                  //目前的stream_request_body  居然缺少xsrf
                  var _xsrf = $("input[name='_xsrf']").val();
                  /*
                  Traceback (most recent call last):
                  File "C:\Python27\lib\site-packages\tornado\web.py", line 1444, in _execute
                    self.check_xsrf_cookie()
                  File "C:\Python27\lib\site-packages\tornado\web.py", line 1285, in check_xsrf_cookie
                    raise HTTPError(403, "'_xsrf' argument missing from POST")
                  HTTPError: HTTP 403: Forbidden ('_xsrf' argument missing from POST)
                  */
                });




                $("#delete_upload").click(function(){
                  $("#speed").addClass('hidden');
                  //删除还需要让已经选择的文件清空，     //未完成
                  $('#filename').prop('value','');
                    //这句原生的实现 document.getElementById('filename').value='';
                });


               $("#ajax_upload").click(function(){

                    //var _xsrf = $("input[name='_xsrf']").val();
                   //改到$.ajaxSetup去提交了

                    var f = document.getElementById('{%raw form.filename.name%}').files; 
                    //var filedata = new FormData(document.forms.namedItem('{%raw form.filename.name%}'));  
                    var filedata = new FormData();
                    //console.log(f[0].name);
                    //console.log(f[0]);
                    //console.log(f.length);

                    for(i=0;i<f.length;i++){          // for(_file in f){
                      filedata.append('file'+i,f[i]);}    // _file);}


                     var url = "/file/ajax";
                     //var data = {'_xsrf':_xsrf};

                     $.ajax({
                        type : "post",
                        //async : false,  //同步请求
                        url : url,
                        //data : data,  //dataType: 'json',

                        data: filedata,
                        processData: false,  // tell jQuery not to process the data
                        contentType: false,  // tell jQuery not to set contentType
                        //timeout:1000,

                        xhr: function(){ //获取原生的xhr对象
                                        var xhr = jQuery.ajaxSettings.xhr();
                                        var progressElem = $('#progressCounter');
                                        xhr.upload.onload = function (){ }
                                        xhr.upload.onprogress = function (ev) {
                                            //alert(ev.lengthComputable)
                                          if(ev.lengthComputable) {
                                          var percent = 100 * ev.loaded/ev.total;
                                          progressElem.attr('value', percent);
                                          //console.log(ev)   //XMLHttpRequestProgressEvent
                                          }
                                        }
                                        return xhr;
                                      },
                        /*xhr: function (){
                                          var xhr = new window.XMLHttpRequest();
                                          //这段代码竟然  async : false 同步请求  时候不起作用
                                          xhr.upload.addEventListener("progress", onprogress, false);
                                          //xhr.addEventListener("progress", onprogress, false);  也能运行，响应慢不少，回调次数少一些
                                          return xhr;
                                      } */
                         /*
                         xhr: function (){
                                          var xhr = new window.XMLHttpRequest();
                                          //这段代码竟然  async : false 同步请求  时候不起作用
                                          xhr.upload.addEventListener("progress",   function (evt) {
                                              var progressElem = $('#progressCounter');
                                              console.log(evt.lengthComputable);//true
                                              if (evt.lengthComputable) {
                                                  var percentComplete = evt.loaded / evt.total;
                                                  //progressElem.html(Math.round(percentComplete * 100) + "%");
                                                  //progressElem.max = evt.total;
                                                  //progressElem.value = evt.loaded;
                                                  progressElem.attr('value', percentComplete);


                                              }
                                          }, false);
                                          //xhr.addEventListener("progress", onprogress, false);  也能运行，响应慢不少，回调次数少一些
                                          return xhr;
                                      }
                                      */
                        
                     }).done(function(datas){                     
                           $("#endContent").html(datas);
                           $('#filename').prop('value','');
                        }).fail(function(){
                              $("#endContent").html("失败，请稍后再试！");
                              //console.log(filedata)
                              //console.log(filedata.length)
                        });
                   //setTimeout(onprogress, 1000);  //验证 可以这样执行

                  });
            </script>

	</body>
</html>

