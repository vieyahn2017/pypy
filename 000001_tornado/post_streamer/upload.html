<!DOCTYPE html>
<html>
   <head>
   	  <meta charset="utf-8"/>
      <title>file upload</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <!-- 引入 Bootstrap -->
      <link href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
      <!--   <link href="style.css" rel="stylesheet">   -->

      <!-- HTML5 Shim 和 Respond.js 用于让 IE8 支持 HTML5元素和媒体查询 -->
      <!-- 注意： 如果通过 file://  引入 Respond.js 文件，则该文件无法起效果 -->
      <!--[if lt IE 9]>
         <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
         <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
      <![endif]-->
      <style type="text/css">
         #speed{
            padding: 5px;
            margin-top: 5px;
            overflow: hidden;
            background: #f4f4f4;
         }
         .bar{
            height: 13px;
            margin-top: 4px;
            width: 15%;
         }
      </style>

   </head>
   <body>
      <div style="text-align: center; padding: 40px 0px;"  height=600>
      </div>

   	<div class="container" >
	   	<div style="text-align: center; padding: 40px 0px;">
	   	</div>


	<form class="form-horizontal"  id="fileform" role="form" action="/file/upload" enctype="multipart/form-data" method="POST">  <!--  -->
        {% raw xsrf_form_html() %}
		    <div class="form-group"> 
		        <!-- {-% raw form.filename.label(class_="col-sm-2 control-label")    %-}  -->
		        <div class="col-sm-10"> 
		            {%raw form.filename(class_="form-control", onChange="_file_show()")  %} 
		        </div> 
		    </div> 
		    <div class="form-group" style="text-align: center;"> 

                 <div class="col-sm-10 col-sm-offset-2">      
                  <div id='speed' class="hidden">
                        <div class="pull-left">
                           <span class="file">xxxxx.text (40.01m)</span>&nbsp; &nbsp; 
                        </div>
                        <div class="progress pull-left bar">
                         <!-- <div id="progressCounter" class="progress-bar progress-bar-info" style="width: 50%;">
                          </div> -->
                          <progress id="progressCounter" value="2" max="100"> </progress>
                        </div>
                        <div class="pull-left">
                           &nbsp; <span>20</span>s/m <span>00:00:20</span> &nbsp; 
                        </div>
                        <div class="pull-left" >         
                           <span id="endContent"></span> <a id="delete_upload" href="#" >删除</a>
                        </div>
                  </div> 

                  

                 </div>  <!-- class="col-sm-10 col-sm-offset-2"  -->


              <a href="#" class="btn btn-success" id="ajax_upload" >上传 AJAX</a> 
              <a href="#" class="btn btn-success" id="post_submit">上传 POST（不要用了） </a>

          
          </div>  <!-- class="form-group"  -->
               		     


      </form>

   	</div>




         <script src="https://code.jquery.com/jquery.js"></script>

            <script type="text/javascript" >

            $.ajaxSetup({
                  beforeSend: function(jqXHR, settings) {
                      type = settings.type
                      if (type != 'GET' && type != 'HEAD' && type != 'OPTIONS') {
                          var pattern = /(.+; *)?_xsrf *= *([^;" ]+)/;
                          var xsrf = pattern.exec(document.cookie);
                          //var _xsrf = $("input[name='_xsrf']").val();
                          //alert(xsrf);alert(_xsrf);
                          if (xsrf) {
                             //jqXHR.setRequestHeader('X-Xsrftoken', _xsrf);
                              //jqXHR.setRequestHeader('X-Xsrftoken',  xsrf[2]);
                              jqXHR.setRequestHeader("X-CSRFToken", xsrf[2]);  //现在对了吧？
                          }
                      }
                    }
                  });

                 function _file_show() {  
                    var f = document.getElementById('{%raw form.filename.name%}').files;  
                    $("#speed").removeClass('hidden');
                    
                    _size_num = f[0].size/1024;
                    num = Math.ceil(_size_num);
                    measure ='kb';
                    if(num<100){ num = _size_num.toFixed(1);}
                    else if(num>1024*1024){ measure ='G';num = (_size_num/1024/1024).toFixed(2);}                      
                    else if(num>1024){ measure ='M';num = (_size_num/1024).toFixed(1);}

                    $("#speed span.file").text(f[0].name + '(' +  num + measure+ ')');
                     $("#endContent").html('');
                }  
            

              $("#post_submit").click(function() {

                    document.getElementById('fileform').submit();
                    var _xsrf = $("input[name='_xsrf']").val();
                  //之前的post可以运行，
                  //目前的stream_request_body  居然缺少xsrf
                  /*
                  Traceback (most recent call last):
                  File "C:\Python27\lib\site-packages\tornado\web.py", line 1444, in _execute
                    self.check_xsrf_cookie()
                  File "C:\Python27\lib\site-packages\tornado\web.py", line 1285, in check_xsrf_cookie
                    raise HTTPError(403, "'_xsrf' argument missing from POST")
                  HTTPError: HTTP 403: Forbidden ('_xsrf' argument missing from POST)
                  */
                });

                $("#delete_upload").click(function(){
                  $("#speed").addClass('hidden');

                  //删除还需要让已经选择的文件清空，
                  //未完成


                });

                

               $("#ajax_upload").click(function(){

                    var _xsrf = $("input[name='_xsrf']").val();
                    var f = document.getElementById('{%raw form.filename.name%}').files; 
                    //var filedata = new FormData(document.forms.namedItem('{%raw form.filename.name%}'));  
                    var filedata = new FormData();
                    //console.log(f[0].name);
                    //console.log(f[0]);
                    //console.log(f.length);

                    for(i=0;i<f.length;i++){          // for(_file in f){
                      filedata.append('file'+i,f[i]);}    // _file);}


                     var url = "/file/ajax";
                     //var data = {'_xsrf':_xsrf};

                     $.ajax({
                        type : "post",
                        //async : false,  //同步请求
                        url : url,
                        //data : data,  //dataType: 'json',

                        data: filedata,
                        processData: false,  // tell jQuery not to process the data
                        contentType: false,  // tell jQuery not to set contentType
                        //timeout:1000,
                        /*
                        xhr: function(){ //这是关键 获取原生的xhr对象 做以前做的所有事情 
                                        var xhr = jQuery.ajaxSettings.xhr(); // 这段代码应该是老版本的
                                        xhr.upload.onload = function (){ 
                                          alert('finish downloading') 
                                          } 
                                        xhr.upload.onprogress = function (ev) { 
                                          if(ev.lengthComputable) { 
                                          var percent = 100 * ev.loaded/ev.total; 
                                          console.log(percent,ev) 
                                          } 
                                        } 
                                        return xhr; 
                                      },  */
                        xhr: function (){
                                          var xhr = new window.XMLHttpRequest();

                                          var progressElem = $('#progressCounter');

                                          //这段代码竟然  async : false 同步请求  时候不起作用
                                          xhr.upload.addEventListener("progress", function(evt) {
                                              //alert(evt.lengthComputable);//true
                                              if (evt.lengthComputable) {
                                                  var percentComplete = evt.loaded / evt.total;
                                                  //progressElem.html(Math.round(percentComplete * 100) + "%");

                                                  //progressElem.max = evt.total;
                                                  //progressElem.value = evt.loaded;
                                                  progressElem.attr('value', percentComplete);

                                              }
                                          }, false);
                                          return xhr;
                                      }
                        
                     }).done(function(datas){                     
                           $("#endContent").html(datas);
                        }).fail(function() {
                              $("#endContent").html("失败，请稍后再试！");
                              //console.log(filedata)
                              //console.log(filedata.length)
                           });

                  });
            </script>

	</body>
</html>

