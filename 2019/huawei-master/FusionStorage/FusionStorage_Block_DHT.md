# FusionStorage Block DHT路由数据算法

FusionStorage Block采用DHT（Distribute Hash Table，分布式哈希表）路由数据算法。每个存储节点负责存储一小部分数据，基于DHT实现整个系统数据的寻址和存储。 
相比DHT路由算法，传统存储一般采用集中式元数据管理方式，元数据中会记录所有LUN中不同偏移量的数据在硬盘中的分布，例如LUN1+LBA1地址起始的4KB长度的数据分布在第32块硬盘的LBA2上。每次IO操作都需要去查询元数据服务，随着系统规模逐渐变大，元数据的容量也会越来越大，系统所能提供的并发操作能力将受限于元数据服务所在服务器的能力，元数据服务将会成为系统的性能瓶颈。不同与传统的集中式元数据管理，FusionStorage Block采用DHT（分布式一致性哈希）进行数据寻址，具体的算法如下图： 
20170424212236823001.png

FusionStorage Block将哈希空间设置为2^32，并将该哈希空间划分为N等份，每1等份是1个分区（Partition），这N等份按照硬盘数量进行均分。例如：系统N默认为3600，假设当前系统有32块硬盘，则每块硬盘承载100个分区。上述"分区-硬盘"的映射关系在系统初始化时会分配好，后续会随着系统中硬盘数量的变化会进行调整。该映射表所需要的空间很小，FusionStorage Block系统中的节点会在内存中保存该映射关系，用于进行快速路由，可见，FusionStorge的路由机制不同于传统阵列，并没有集中的元数据管理，也就不存在元数据服务成为系统的性能瓶颈。 
举例说明：应用需要访问LUN1+LBA1地址起始的4KB长度的数据，首先构造key=LUN1+LBA1/1M，对该key进行HASH计算得到哈希值，并对N取模，得到partition号，根据内存中记录的"分区-硬盘"映射表可得知数据归属的硬盘。 
同时，FusionStorage Block采用的DHT算法具有以下特点：

l   均衡性：数据能够尽可能分布到所有的节点中，这样可以使得所有节点负载均衡。
l   单调性：当有新节点加入系统中，系统会重新做数据分配，数据迁移仅涉及新增节点，现有节点上的数据不需要做很大调整。
